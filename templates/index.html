<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; }
        .container { max-width: 400px; margin: 50px auto; padding: 20px; background: white; border-radius: 10px; }
        .avatar { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 10px; }
        #status { color: #d32f2f; }
        pre { text-align: left; background: #eee; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="status">Initializing...</div>
        <img id="avatar" src="/static/default-avatar.png" alt="User Avatar">
        <div id="name">--</div>
        <div id="meta">--</div>
        <pre id="output">Waiting for data...</pre>
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        (async () => {
            const status = document.getElementById('status');
            const avatar = document.getElementById('avatar');
            const name = document.getElementById('name');
            const meta = document.getElementById('meta');
            const output = document.getElementById('output');

            const tg = window.Telegram?.WebApp;
            if (!tg) {
                status.textContent = '❌ Please open this in Telegram.';
                return;
            }

            tg.ready();
            const initData = tg.initData;

            if (!initData || !initData.includes('hash=')) {
                status.textContent = '⚠️ Invalid initData. Open via Telegram.';
                return;
            }

            // Step 1: Verify with backend
            status.textContent = 'Verifying data...';
            try {
                const response = await fetch('/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData })
                });
                const result = await response.json();
                output.textContent = JSON.stringify(result, null, 2);

                if (!result.ok) {
                    status.textContent = `❌ ${result.error || 'Verification failed'}`;
                    return;
                }

                status.textContent = '✅ Verified';

                // Step 2: Use verified data or initDataUnsafe after confirmation
                let user;
                if (result.user) {
                    user = result.user;  // Prefer backend-parsed user if available
                } else if (result.data && result.data.user) {
                    user = JSON.parse(result.data.user);
                } else {
                    user = tg.initDataUnsafe.user;
                }
                if (user) {
                    name.textContent = [user.first_name, user.last_name].filter(Boolean).join(' ') || 'User';
                    meta.textContent = user.username ? `@${user.username}` : `ID: ${user.id}`;
                    avatar.src = user.photo_url || '/static/default-avatar.png';
                } else {
                    status.textContent = '⚠️ User info not found';
                }
            } catch (error) {
                status.textContent = `Error: ${error.message || 'Network issue'}`;
                output.textContent = JSON.stringify({ error: error.message || 'Unknown error' }, null, 2);
            }
        })();
    </script>
</body>
</html>
