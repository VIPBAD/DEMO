<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Music Web App — Profile</title>
<style>
  body{font-family:system-ui,Arial;margin:0;background:linear-gradient(#12081a,#24132b);color:#fff;padding:18px}
  .card{max-width:760px;margin:12px auto;padding:16px;border-radius:12px;background:rgba(255,255,255,0.03);box-shadow:0 6px 24px rgba(0,0,0,0.6)}
  img.avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.08)}
  pre{background:#0b0b0f;padding:12px;border-radius:8px;overflow:auto}
  .row{display:flex;gap:12px;align-items:center}
  .small{font-size:13px;color:#ddd}
</style>
</head>
<body>
  <div class="card">
    <h2>WebApp Debug / Profile</h2>
    <div class="row">
      <img id="avatar" class="avatar" src="/static/default-avatar.png" alt="avatar">
      <div>
        <div id="fullname" style="font-weight:700">—</div>
        <div id="username" style="opacity:0.9;">—</div>
        <div id="userid" class="small">—</div>
      </div>
    </div>

    <h3>Init data (unsafe)</h3>
    <pre id="initUnsafe">not available</pre>

    <h3>Init data (signed)</h3>
    <pre id="initSigned">not available</pre>

    <h3>GET /get_profile_photo result</h3>
    <pre id="photoResult">not called yet</pre>

    <h3>Instructions</h3>
    <ul>
      <li>Open this page <strong>inside Telegram</strong> by clicking your bot's WebApp button (the inline button that says "Open Music WebApp").</li>
    </ul>
  </div>

<script>
  const initUnsafeEl = document.getElementById('initUnsafe');
  const initSignedEl = document.getElementById('initSigned');
  const fullnameEl = document.getElementById('fullname');
  const usernameEl = document.getElementById('username');
  const useridEl = document.getElementById('userid');
  const avatarEl = document.getElementById('avatar');
  const photoResultEl = document.getElementById('photoResult');

  // Manual tester UI (for non-Telegram testing)
  const card = document.querySelector('.card');
  const manualDiv = document.createElement('div');
  manualDiv.style.marginTop = '14px';
  manualDiv.innerHTML = `
    <div style="margin-bottom:8px"><strong>Manual test (use when not opened from Telegram)</strong></div>
    <input id="manualUserId" placeholder="Enter user_id to fetch profile photo" style="padding:8px;border-radius:6px;border:0;outline:0;width:58%" />
    <button id="manualBtn" style="padding:8px 12px;border-radius:6px;border:0;margin-left:8px;cursor:pointer">Fetch</button>
    <div id="manualMsg" style="margin-top:8px;font-size:13px;opacity:0.9"></div>
  `;
  card.appendChild(manualDiv);

  document.getElementById('manualBtn').addEventListener('click', () => {
    const uid = document.getElementById('manualUserId').value.trim();
    if(!uid){ document.getElementById('manualMsg').textContent = 'Please enter a user id.'; return; }
    document.getElementById('manualMsg').textContent = 'loading...';
    fetch('/get_profile_photo?user_id=' + encodeURIComponent(uid), {cache: "no-store", credentials: "same-origin"})
      .then(r => r.json())
      .then(js => {
        document.getElementById('manualMsg').textContent = JSON.stringify(js);
        avatarEl.src = (js && js.photo_url) ? js.photo_url : "/static/default-avatar.png";
        fullnameEl.textContent = 'Manual test';
        usernameEl.textContent = '';
        useridEl.textContent = 'user.id = ' + uid;
      })
      .catch(err => {
        document.getElementById('manualMsg').textContent = 'Error: ' + err.message;
      });
  });

  const tg = window.Telegram?.WebApp;

  function showNotInsideTelegram() {
    initUnsafeEl.textContent = "Telegram.WebApp not available — open via the bot's WebApp button inside the Telegram app.";
    initSignedEl.textContent = "n/a";
    fullnameEl.textContent = "Open inside Telegram";
    usernameEl.textContent = "";
    useridEl.textContent = "";
    photoResultEl.textContent = "Open this page from inside Telegram to auto-load your profile. Or use manual test below.";
  }

  if (!tg) {
    showNotInsideTelegram();
    console.warn("Telegram.WebApp not available. Open via bot's WebApp button inside Telegram.");
  } else {
    try{ tg.expand(); }catch(e){}
    const unsafe = tg.initDataUnsafe || null;
    const signed = tg.initData || null;
    initUnsafeEl.textContent = JSON.stringify(unsafe, null, 2);
    initSignedEl.textContent = signed ? JSON.stringify(signed, null, 2) : "not provided";

    const user = unsafe?.user || null;
    if (user) {
      const fullname = [user.first_name, user.last_name].filter(Boolean).join(' ');
      fullnameEl.textContent = fullname || "Unknown";
      usernameEl.textContent = user.username ? ("@" + user.username) : "";
      useridEl.textContent = "user.id = " + user.id;

      photoResultEl.textContent = "loading...";
      const endpoint = '/get_profile_photo?user_id=' + encodeURIComponent(user.id);
      fetch(endpoint, {cache: "no-store", credentials: "same-origin"})
        .then(r => {
          if(!r.ok) throw new Error("network " + r.status);
          return r.json();
        })
        .then(js => {
          photoResultEl.textContent = JSON.stringify(js, null, 2);
          avatarEl.src = (js && js.photo_url) ? js.photo_url : "/static/default-avatar.png";
        })
        .catch(err => {
          photoResultEl.textContent = "fetch error: " + (err.message || err);
          avatarEl.src = "/static/default-avatar.png";
        });
    } else {
      initUnsafeEl.textContent = JSON.stringify(unsafe, null, 2);
      useridEl.textContent = "initDataUnsafe.user not present";
      photoResultEl.textContent = "user info not present in initDataUnsafe";
    }
  }
</script>
</body>
</html>
