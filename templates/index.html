<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    (async () => {
        const status = document.getElementById('status');
        const avatar = document.getElementById('avatar');
        const name = document.getElementById('name');
        const meta = document.getElementById('meta');
        const output = document.getElementById('output');

        const tg = window.Telegram?.WebApp;
        if (!tg) {
            status.textContent = '❌ Please open this in Telegram.';
            return;
        }

        tg.ready();
        const initData = tg.initData;
        const initDataUnsafe = tg.initDataUnsafe;

        if (!initData || !initData.includes('hash=')) {
            status.textContent = '⚠️ Invalid initData. Open via Telegram.';
            return;
        }

        // ✅ Pehle backend verify kar lo
        const response = await fetch('/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ initData })
        });
        const result = await response.json();
        output.textContent = JSON.stringify(result, null, 2);

        if (!result.ok) {
            status.textContent = `❌ ${result.error || 'Verification failed'}`;
            return;
        }

        // ✅ Phir frontend se user info uthao
        const user = initDataUnsafe.user;
        if (user) {
            status.textContent = '✅ Verified';
            name.textContent = [user.first_name, user.last_name].filter(Boolean).join(' ') || 'User';
            meta.textContent = user.username ? `@${user.username}` : `ID: ${user.id}`;
            avatar.src = user.photo_url || '/static/default-avatar.png';
        } else {
            status.textContent = '⚠️ User info not found';
        }
    })();
</script>
